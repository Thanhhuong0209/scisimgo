name: Release Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      release_type:
        description: 'Type of release'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch
      draft:
        description: 'Create as draft release'
        required: false
        default: false
        type: boolean
      prerelease:
        description: 'Create as prerelease'
        required: false
        default: false
        type: boolean

env:
  GO_VERSION: '1.21'
  PYTHON_VERSION: '3.11'

jobs:
  version:
    name: Version Management
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Release version: $VERSION"
    - name: Validate version format
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
          echo "Invalid version format: $VERSION"
          echo "Expected format: vX.Y.Z[-prerelease][+build]"
          exit 1
        fi
        echo "Version format is valid: $VERSION"

  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [version]
    strategy:
      matrix:
        go-version: [1.20, 1.21, 1.22]
        os: [linux, windows, darwin]
        arch: [amd64, arm64]
      exclude:
        - os: windows
          arch: arm64
        - os: darwin
          arch: arm64
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Go ${{ matrix.go-version }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
        cache: true
    - name: Verify Go installation
      run: |
        go version
        go env GOPATH
        go env GOROOT
    - name: Install dependencies
      run: |
        go mod download
        go mod verify
    - name: Build Go binaries
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        VERSION_NUM="${VERSION#v}"
        
        mkdir -p dist
        
        # Build SIR simulator
        echo "Building SIR simulator for ${{ matrix.os }}/${{ matrix.arch }}..."
        GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build \
          -ldflags "-X main.version=$VERSION_NUM -X main.buildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          -o "dist/sir-simulator-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}" \
          ./cmd/sir-simulator || echo "SIR simulator build failed for ${{ matrix.os }}/${{ matrix.arch }}"
        
        # Build Predator-Prey simulator
        echo "Building Predator-Prey simulator for ${{ matrix.os }}/${{ matrix.arch }}..."
        GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build \
          -ldflags "-X main.version=$VERSION_NUM -X main.buildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          -o "dist/predator-prey-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}" \
          ./cmd/predator-prey || echo "Predator-Prey simulator build failed for ${{ matrix.os }}/${{ matrix.arch }}"
        
        # Build Orbital simulator
        echo "Building Orbital simulator for ${{ matrix.os }}/${{ matrix.arch }}..."
        GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build \
          -ldflags "-X main.version=$VERSION_NUM -X main.buildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
          -o "dist/orbital-sim-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}" \
          ./cmd/orbital-sim || echo "Orbital simulator build failed for ${{ matrix.os }}/${{ matrix.arch }}"
    - name: Upload Go binaries
      uses: actions/upload-artifact@v3
      with:
        name: go-binaries-${{ matrix.go-version }}-${{ matrix.os }}-${{ matrix.arch }}
        path: dist/
        retention-days: 90

  python-package:
    name: Python Package
    runs-on: ubuntu-latest
    needs: [version]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    - name: Verify Python installation
      run: |
        python --version
        pip --version
    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build setuptools wheel
    - name: Create Python package
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        VERSION_NUM="${VERSION#v}"
        
        # Create setup.py if it doesn't exist
        if [ ! -f "setup.py" ]; then
          cat > setup.py << 'EOF'
from setuptools import setup, find_packages

setup(
    name="scisimgo",
    version="$VERSION_NUM",
    description="Scientific Simulation Engine with Data Science Integration",
    author="SciSimGo Team",
    packages=find_packages(),
    install_requires=[
        line.strip()
        for line in open("requirements.txt")
        if line.strip() and not line.startswith("#")
    ],
    python_requires=">=3.9",
)
EOF
        fi
        
        # Build package
        python -m build --wheel --sdist
        echo "Python package created successfully"
    - name: Upload Python package
      uses: actions/upload-artifact@v3
      with:
        name: python-package
        path: dist/*.whl dist/*.tar.gz
        retention-days: 90

  checksums:
    name: Generate Checksums
    runs-on: ubuntu-latest
    needs: [build, python-package]
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    - name: Generate checksums
      run: |
        echo "Generating checksums for all files..."
        find . -type f -name "*.exe" -o -name "*.bin" -o -name "*.whl" -o -name "*.tar.gz" | while read file; do
          if [ -f "$file" ]; then
            echo "Generating checksum for: $file"
            sha256sum "$file" >> checksums.txt
          fi
        done
        
        if [ -f "checksums.txt" ]; then
          echo "Checksums generated:"
          cat checksums.txt
        else
          echo "No files found for checksum generation"
        fi
    - name: Upload checksums
      uses: actions/upload-artifact@v3
      with:
        name: checksums
        path: checksums.txt
        retention-days: 90

  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: [version]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Generate changelog
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        VERSION_NUM="${VERSION#v}"
        
        echo "# Changelog for $VERSION" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## Release Date: $(date -u +'%Y-%m-%d')" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # Get commits since last tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "## Changes since $PREVIOUS_TAG" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --oneline --no-merges "$PREVIOUS_TAG..HEAD" | while read commit; do
            echo "- $commit" >> CHANGELOG.md
          done
        else
          echo "## Initial Release" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --oneline --no-merges | while read commit; do
            echo "- $commit" >> CHANGELOG.md
          done
        fi
        
        echo "" >> CHANGELOG.md
        echo "## Features" >> CHANGELOG.md
        echo "- Scientific simulation engine in Go" >> CHANGELOG.md
        echo "- SIR disease model simulation" >> CHANGELOG.md
        echo "- Predator-Prey ecosystem simulation" >> CHANGELOG.md
        echo "- Orbital mechanics simulation" >> CHANGELOG.md
        echo "- Data export and analysis pipeline" >> CHANGELOG.md
        echo "- Comprehensive CI/CD workflows" >> CHANGELOG.md
        
        echo "Changelog generated successfully"
        cat CHANGELOG.md
    - name: Upload changelog
      uses: actions/upload-artifact@v3
      with:
        name: changelog
        path: CHANGELOG.md
        retention-days: 90

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [version, build, python-package, checksums, changelog]
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: ${{ needs.version.result == 'success' }}
      with:
        tag_name: ${{ needs.version.outputs.version }}
        name: "Release ${{ needs.version.outputs.version }}"
        body_path: CHANGELOG.md
        files: |
          **/*.exe
          **/*.bin
          **/*.whl
          **/*.tar.gz
          checksums.txt
        draft: ${{ github.event.inputs.draft }}
        prerelease: ${{ github.event.inputs.prerelease }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Release Status
    runs-on: ubuntu-latest
    needs: [version, release]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Release Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.release.result }}" = "success" ]; then
            echo "Release ${{ needs.version.outputs.version }} created successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Release Details" >> $GITHUB_STEP_SUMMARY
            echo "- Version: ${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- Type: ${{ github.event.inputs.release_type || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
            echo "- Draft: ${{ github.event.inputs.draft && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
            echo "- Pre-release: ${{ github.event.inputs.prerelease && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "Release creation failed!" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
